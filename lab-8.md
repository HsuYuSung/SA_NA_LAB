
# LAB-08



###### tags: `Computer Science`

## Step
### Step1

1. Install gw server
* Setup environment
	* `sudo apt install openssh-server wireguard resolvconf`
* Add sudo permission without password to the user
```
	sudo bash -c 'echo "p76091543 ALL=(ALL:ALL) NOPASSWD:ALL" > /etc/sudoers.d/p76091543'
```
* ssh
	* `$ ssh p76091543@192.168.229.132`
	* method2
```
ssh-copy-id -i ~/.ssh/id_rsa_ncku.pub gw
```

### Step2 setup clt server
### Step3 Set wireguard
* Copy wg config file to VM
    * `scp wan.conf gw`
* Move wg config to wireguard settings
    * `sudo mv wan.conf /etc/wireguard
`
* Start the wireguard VPN services
`sudo wg-quick up wan` or `sudo systemctl start wg-quick@wan.service`
* Auto start wireguard VPN services at boot
    * `sudo systemctl enable wg-quick@wan.service`

```bash=
p76091543@gw:~$ sudo wg-quick up wan
[#] ip link add wan type wireguard
[#] wg setconf wan /dev/fd/63
[#] ip -4 address add 10.100.100.49/24 dev wan
[#] ip link set mtu 1420 up dev wan
[#] resolvconf -a tun.wan -m 0 -x
[#] wg set wan fwmark 51820
[#] ip -4 route add 0.0.0.0/0 dev wan table 51820
[#] ip -4 rule add not fwmark 51820 table 51820
[#] ip -4 rule add table main suppress_prefixlength 0
[#] sysctl -q net.ipv4.conf.all.src_valid_mark=1
[#] iptables-restore -n
[#] iptables -t mangle -A FORWARD -p tcp -m tcp --tcp-flags SYN,RST SYN -j TCPMSS --clamp-mss-to-pmtu
[#] bash -c "for a in \$(seq 1 1 \$(iptables-save | grep \"\\\"wg-quick(8) rule for wan\\\" -j DROP\" | sed 's/-A/-D/g' | wc -l)); do bash -c \"iptables -t raw \$(iptables-save | grep \"\\\"wg-quick(8) rule for wan\\\" -j DROP\" | sed 's/-A/-D/g' | head -n 1)\"; done"
p76091543@gw:~$ sudo wg-quick up wan
wg-quick: `wan' already exists
p76091543@gw:~$ sudo systemctl enable wg-quick@wan.service
Created symlink /etc/systemd/system/multi-user.target.wants/wg-quick@wan.service → /lib/systemd/system/wg-quick@.service.
p76091543@gw:~$
```


### Step4 change name

```yaml
# gw
network:
  ethernets:
    ens33:
      dhcp4: true
    lan:
            dhcp4: false
            addresses: [192.168.3.154/24]
            match:
                    macaddress: "00:0c:29:44:33:a2"
            set-name: lan
  version: 2
```

```yaml
# clt
# This is the network config written by 'subiquity'
network:
  ethernets:
    eth0:
            dhcp4: true
            addresses: [192.168.3.100/24]
            nameservers:
                    addresses: [10.100.100.254]
            routes:
                    - to: default
                      via: 192.168.3.254
            match:
                    macaddress: "00:0c:29:2c:b5:a0"
            set-name: eth0
  version: 2
```


### Step5
open forwarding on linux
```bash
sudo vim /etc/sysctl.conf
sudo sysctl -p

# check forwarding function
cat /proc/sys/net/ipv4/ip_forward
```

test iptables
```bash
# sudo iptables -t nat -A INPUT -s 192.168.3.100 -p tcp -m tcp --sport 44444 -j SNAT --to 10.100.100.49:10000

sudo iptables -t filter -A INPUT -i lo -j ACCEPT
sudo iptables -t filter -A INPUT -p tcp -m tcp -m multiport --dports 22 -j ACCEPT
sudo iptables -t filter -A INPUT -p tcp -j ACCEPT
sudo iptables -t filter -A INPUT -m state --state RELATED,ESTABLISHED -j ACCEPT
sudo iptables -t filter -A INPUT -j DROP
sudo iptables -t filter -A FORWARD 

iptables -t nat -A POSTROUTING -o wan -s 192.168.0.0/24 -j MASQUERADE

sudo iptables -t nat -A PREROUTING -i wan -p tcp -m tcp -m multiport --dports 22 -j DNAT --to 192.168.3.254

ptables -t nat -A PREROUTING -i wan -p tcp -m tcp --dports 22 -j DNAT --to 192.168.3.100
```



### Step6 Setup iptables
- nat 要做的事情就是要把 clt 的 ip 對應到外網的 ip ，這裡的外網就是 vpn 的網卡。
- nat 將 POSTROUTING 將來源 ip 修改成對外網卡 ip
- MASQUERADE 將 source ip 轉換成 wan 當下對應的 ip

final iptables :
```bash
# Generated by iptables-save v1.8.4 on Wed May  4 15:05:39 2022
# this tables got 60 scores
*nat
:PREROUTING ACCEPT [49:4488]
:INPUT ACCEPT [0:0]
:OUTPUT ACCEPT [8:1610]
:POSTROUTING ACCEPT [9:1938]
-A POSTROUTING -s 192.168.3.100 -o wan -j MASQUERADE
COMMIT
# Completed on Wed May  4 15:05:39 2022
# Generated by iptables-save v1.8.4 on Wed May  4 15:05:39 2022
*filter
:INPUT ACCEPT [0:0]
:FORWARD ACCEPT [4:1312]
:OUTPUT ACCEPT [832:94094]
-A INPUT -p icmp -j ACCEPT
-A INPUT -i lo -j ACCEPT
-A INPUT -p tcp -m tcp -m multiport --dports 22 -j ACCEPT
-A INPUT -m state --state RELATED,ESTABLISHED -j ACCEPT
-A INPUT -j DROP
COMMIT
# Completed on Wed May  4 15:05:39 2022
# Generated by iptables-save v1.8.4 on Wed May  4 15:05:39 2022
*mangle
:PREROUTING ACCEPT [2208:181162]
:INPUT ACCEPT [2200:179658]
:FORWARD ACCEPT [4:1312]
:OUTPUT ACCEPT [1367:157622]
:POSTROUTING ACCEPT [1370:158578]
-A PREROUTING -p udp -m comment --comment "wg-quick(8) rule for wan" -j CONNMARK --restore-mark --nfmask 0xffffffff --ctmask 0xffffffff
-A FORWARD -p tcp -m tcp --tcp-flags SYN,RST SYN -j TCPMSS --clamp-mss-to-pmtu
-A POSTROUTING -p udp -m mark --mark 0xca6c -m comment --comment "wg-quick(8) rule for wan" -j CONNMARK --save-mark --nfmask 0xffffffff --ctmask 0xffffffff
COMMIT
# Completed on Wed May  4 15:05:39 2022
# Generated by iptables-save v1.8.4 on Wed May  4 15:05:39 2022
*raw
:PREROUTING ACCEPT [2208:181162]
:OUTPUT ACCEPT [1367:157622]
COMMIT
# Completed on Wed May  4 15:05:39 2022
```
